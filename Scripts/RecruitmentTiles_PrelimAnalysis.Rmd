---
title: "RecruitmentTiles_PrelimAnalysis"
author: "Hannah Merges"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE)
```

## Load libraries 
```{r}
library(segmented)
library(plotrix)
library(gridExtra)
library(LoLinR)
library(lubridate)
library(chron)
library(patchwork)
library(tidyverse)
library(here)
library(PNWColors)
library(ggrepel)
library(reshape2)
library(viridis)
library(car)
library(GGally)
library(corrplot)
library(PNWColors)
library(seacarb)
library(broom)
library(calecopal)
library(ggridges)
library(agricolae)
library(lme4)
library(lmerTest)
library(modelsummary)
library(tidymodels)
library(flextable)
library(performance)
library(agricolae)
library(ggeffects)
library(sjPlot)
library(patchwork)
library(broom)
library(purrr)
library(nlstools)
library(stringr)
library(emmeans)
library(MuMIn)
library(forcats)
library(ggmap)
library(maptools)
library(kriging)
library(ggnewscale)
library(wql)
library(pscl)
library(modelr)
```

## Bring in datasets
```{r}
RecruitmentCounts <- read_csv(here("Data","Recruitment_Tiles_Counts.csv"))
AllChemData_August <- read_csv("https://raw.githubusercontent.com/njsilbiger/MooreaSGD_site-selection/main/Data/August2021/Allbiogeochemdata_QC.csv")
AllChemData_March <- read_csv("https://raw.githubusercontent.com/njsilbiger/MooreaSGD_site-selection/main/Data/March2022/Allbiogeochemdata_QC_march_fdom2.csv")
PercentCover <- read_csv("https://raw.githubusercontent.com/dbarnas/Community_Functional_Diversity/main/Data/Full_Metadata.csv")
pH <- read_csv(here("Data", "pHSlope.csv"))
```

### delete extra low tide from Varari on 08/06 in AUGUST dataframe and AVERAGE with March 
## DONT FORGET TO REMOVE SEEP DATA !!! 
```{r}

AllChemData_August <- AllChemData_August %>% 
  filter(CowTagID!="CSEEP", CowTagID!="VSEEP", CowTagID!="CSPRING", CowTagID!="Varari_Well") %>% 
  group_by(Location, Tide, Date) %>% 
  filter(Date!="2021-08-06") 

AllChemData_March$Date <- mdy(AllChemData_March$Date)

AllChemData_March <- AllChemData_March %>% 
  filter(CowTagID!="CSEEP", CowTagID!="VSEEP", CowTagID!="VRC", CowTagID!="CRC", CowTagID!="CPIT", CowTagID!="CPIT_Bottom", CowTagID!="CSPRING_ROAD", CowTagID!="CSPRING_BEACH", CowTagID!="CSPRING_BEACH2", CowTagID!="VSPRING") %>% 
  filter(TA > 2096)
  

AllChemData_seasonaverage <- AllChemData_August %>% 
  full_join(AllChemData_March)

  
```

## join dfs 
```{r}

full_CommunityRecruit <- PercentCover %>% 
  left_join(RecruitmentCounts, join_by(CowTagID, Location))

full_envdataRecruits_avgseason <- full_CommunityRecruit %>% 
  left_join(AllChemData_seasonaverage, join_by(Location, CowTagID, lat, lon)) %>% 
  select(!c("Top_Plate_ID", "Bottom_Plate_ID", "Jamie_Plate_ID", "Time", "DateTime", "M_C":"Lignin_Like"))

#full_envdataRecruits_August <- full_CommunityRecruit %>% 
 # left_join(AllChemData_August, join_by(Location, CowTagID, lat, lon))

#full_envdataRecruits_March <- full_CommunityRecruit %>% 
  #left_join(AllChemData_March, join_by(Location, CowTagID, lat, lon))

```

# tidy this now fully complete and joined dataset 
```{r}
#full_envdataRecruits_avgseason <- full_envdataRecruits_avgseason %>% 
  #select(!c("Top_Plate_ID", "Bottom_Plate_ID", "Jamie_Plate_ID", "Time", "DateTime", "M_C":"Lignin_Like"))

#full_envdataRecruits_March <- full_envdataRecruits_March %>% 
 # select(!c("Top_Plate_ID", "Bottom_Plate_ID", "Jamie_Plate_ID", "Time", "DateTime", "M_C":"Lignin_Like"))

```

# group and average the day/night and high/low tide measurements for August AND March  - average together 
```{r}
## calculating MEAN only  
full_envdataRecruits_avgseason2 <- full_envdataRecruits_avgseason %>% 
  select(!c("Date", "Tide", "Day_Night", "Plate_Seep")) %>% 
  group_by(CowTagID) %>% 
  summarise(avgSal=mean(Salinity, na.rm=TRUE), 
         avgTemp=mean(Temperature, na.rm=TRUE), 
         avgTA=mean(TA, na.rm=TRUE), 
         avgpH=mean(pH, na.rm=TRUE), 
         avgPhosphate=mean(Phosphate_umolL, na.rm=TRUE), 
         avgSilicate=mean(Silicate_umolL, na.rm=TRUE),
         avgNN=mean(NN_umolL, na.rm=TRUE), 
         avgAmmonia=mean(Ammonia_umolL, na.rm=TRUE))

#full_envdataRecruits_August3 <- full_envdataRecruits_August2 %>% 
  #full_join(full_CommunityRecruit, join_by(CowTagID)) 

## March 
#full_envdataRecruits_March2 <- full_envdataRecruits_March %>% 
  #select(!c("Date", "Tide", "Day_Night", "Plate_Seep")) %>% 
  #group_by(CowTagID) %>% 
  #summarise(avgSal=mean(Salinity, na.rm=TRUE), 
         #avgTemp=mean(Temperature, na.rm=TRUE), 
        # avgTA=mean(TA, na.rm=TRUE), 
         #avgpH=mean(pH, na.rm=TRUE), 
       #  avgPhosphate=mean(Phosphate_umolL, na.rm=TRUE), 
        # avgSilicate=mean(Silicate_umolL, na.rm=TRUE),
         #avgNN=mean(NN_umolL, na.rm=TRUE), 
         #avgAmmonia=mean(Ammonia_umolL, na.rm=TRUE))

#full_envdataRecruits_March3 <- full_envdataRecruits_March2 %>% 
 # full_join(full_CommunityRecruit, join_by(CowTagID)) 
  
```

## group percent cover data and tidy into useful format 
```{r}
PercentCover <- PercentCover %>% 
  select(!c("del15N":"N_percent", "adj_CT_depth_cm", "meanRugosity"))

PercentCover2 <- PercentCover %>% 
  pivot_longer(cols = LiveCoral:Sand, names_to = "comm_type", values_to = "percent_cover") %>% 
  group_by(comm_type, CowTagID, Location) %>% 
  summarize(percent_total=sum(percent_cover)) 

PercentCover3 <- PercentCover2 %>% 
  group_by(comm_type) %>% 
  pivot_wider(names_from = CowTagID, values_from = percent_total) 

PercentCover3 <- PercentCover3 %>% 
  group_by(comm_type) %>% 
  select(!starts_with(c("Reef","RockWall","Sand"))) %>% ## gets rid of the extra data that I don't need - columns that start with Reef, Rockwall, or Sand 
  pivot_longer(cols = C1:VSEEP, names_to = "CowTagID", values_to = "percent_cover") %>% 
  drop_na(percent_cover) %>% 
  write_csv(here("Data", "Percentcover3.csv"))

################
## goal: convert all hard substrate into one category compared to sand 

PercentCover_BinomialSubstrate <- PercentCover3 %>% 
  pivot_wider(names_from = comm_type, values_from = percent_cover) %>% 
  group_by(CowTagID) %>% 
  mutate(HardSubstrate = DeadCoral+LiveCoral+Rubble) %>% 
  select(!c(DeadCoral,LiveCoral,Rubble))
  
```


## Calcualting CV, mean, max, min from averaged August and March data 

```{r}
####################
### this is the same as: full_envdataRecruits2
#full_envdataRecruits_avgseason2 <- full_envdataRecruits_avgseason2 %>% 
#  select(!c("Top_Plate_ID":"Plate_Seep", "M_C":"Lignin_Like")) 
  
AllChemDataSeasonAvg_calculatedvalues <- AllChemData_seasonaverage %>% 
  group_by(CowTagID) %>% 
  summarize(sal_avg = mean(Salinity), 
            temp_avg = mean(Temperature), 
            TA_avg = mean(TA), 
            pH_avg = mean(pH), 
            phos_avg = mean(Phosphate_umolL), 
            NN_avg = mean(NN_umolL),  
            silicate_avg= mean(Silicate_umolL), 
            ammonia_avg = mean(Ammonia_umolL),  
            sal_max = max(Salinity),
            temp_max = max(Temperature), 
            TA_max = max(TA), 
            pH_max = max(pH), 
            phos_max = max(Phosphate_umolL), 
            NN_max = max(NN_umolL), 
            silicate_max= max(Silicate_umolL), 
            ammonia_max = max(Ammonia_umolL), 
            sal_min = min(Salinity), 
            temp_min = min(Temperature), 
            TA_min = min(TA), 
            pH_min = min(pH), 
            phos_min = min(Phosphate_umolL), 
            NN_min = min(NN_umolL),
            silicate_min= min(Silicate_umolL), 
            ammonia_min = min(Ammonia_umolL), 
            sal_CV = ((sd(Salinity)/mean(Salinity))/100), 
            temp_CV = ((sd(Temperature)/mean(Temperature))/100), 
            TA_CV = ((sd(TA)/mean(TA))/100), 
            pH_CV = ((sd(pH)/mean(pH))/100),
            phos_CV = ((sd(Phosphate_umolL)/mean(Phosphate_umolL))/100), 
            NN_CV = ((sd(NN_umolL)/mean(NN_umolL))/100), 
            silicate_CV= ((sd(Silicate_umolL)/mean(Silicate_umolL))/100), 
            ammonia_CV = ((sd(Ammonia_umolL)/mean(Ammonia_umolL))/100), 
            sal_sd = sd(Salinity), 
            temp_sd = sd(Temperature), 
            TA_sd = sd(TA), 
            pH_sd = sd(pH), 
            phos_sd = sd(Phosphate_umolL), 
            NN_sd = sd(NN_umolL), 
            silicate_sd= sd(Silicate_umolL),
            ammonia_sd = sd(Ammonia_umolL))

##### FIGURE OUT HOW TO PROPERLY USE na.rm = TRUE 
AllChemDataSeasonAvg_calculatedvalues2 <- AllChemData_seasonaverage %>% 
  group_by(CowTagID) %>% 
  summarize(sal_avg = mean(Salinity, na.rm=TRUE), 
            temp_avg = mean(Temperature, na.rm=TRUE), 
            TA_avg = mean(TA, na.rm=TRUE), 
            pH_avg = mean(pH, na.rm=TRUE), 
            phos_avg = mean(Phosphate_umolL, na.rm=TRUE), 
            NN_avg = mean(NN_umolL, na.rm=TRUE),  
            silicate_avg= mean(Silicate_umolL, na.rm=TRUE), 
            ammonia_avg = mean(Ammonia_umolL, na.rm=TRUE),  
            sal_max = max(Salinity, na.rm=TRUE),
            temp_max = max(Temperature, na.rm=TRUE), 
            TA_max = max(TA, na.rm=TRUE), 
            pH_max = max(pH, na.rm=TRUE), 
            phos_max = max(Phosphate_umolL, na.rm=TRUE), 
            NN_max = max(NN_umolL, na.rm=TRUE), 
            silicate_max= max(Silicate_umolL, na.rm=TRUE), 
            ammonia_max = max(Ammonia_umolL, na.rm=TRUE), 
            sal_min = min(Salinity, na.rm=TRUE), 
            temp_min = min(Temperature, na.rm=TRUE), 
            TA_min = min(TA, na.rm=TRUE), 
            pH_min = min(pH, na.rm=TRUE), 
            phos_min = min(Phosphate_umolL, na.rm=TRUE), 
            NN_min = min(NN_umolL, na.rm=TRUE),
            silicate_min= min(Silicate_umolL, na.rm=TRUE), 
            ammonia_min = min(Ammonia_umolL, na.rm=TRUE), 
            sal_CV = ((sd(Salinity, na.rm=TRUE)/mean(Salinity, na.rm=TRUE))/100), 
            temp_CV = ((sd(Temperature, na.rm=TRUE)/mean(Temperature, na.rm=TRUE))/100), 
            TA_CV = ((sd(TA, na.rm=TRUE)/mean(TA, na.rm=TRUE))/100), 
            pH_CV = ((sd(pH, na.rm=TRUE)/mean(pH, na.rm=TRUE))/100),
            phos_CV = ((sd(Phosphate_umolL, na.rm=TRUE)/mean(Phosphate_umolL, na.rm=TRUE))/100), 
            NN_CV = ((sd(NN_umolL, na.rm=TRUE)/mean(NN_umolL, na.rm=TRUE))/100), 
            silicate_CV= ((sd(Silicate_umolL, na.rm=TRUE)/mean(Silicate_umolL, na.rm=TRUE))/100), 
            ammonia_CV = ((sd(Ammonia_umolL, na.rm=TRUE)/mean(Ammonia_umolL, na.rm=TRUE))/100), 
            sal_sd = sd(Salinity, na.rm=TRUE), 
            temp_sd = sd(Temperature, na.rm=TRUE), 
            TA_sd = sd(TA, na.rm=TRUE), 
            pH_sd = sd(pH, na.rm=TRUE), 
            phos_sd = sd(Phosphate_umolL, na.rm=TRUE), 
            NN_sd = sd(NN_umolL, na.rm=TRUE), 
            silicate_sd= sd(Silicate_umolL, na.rm=TRUE),
            ammonia_sd = sd(Ammonia_umolL, na.rm=TRUE))
#### for March 
#AllChemData_Marchedit <- AllChemData_March %>% 
 # select(!c("Top_Plate_ID":"Plate_Seep", "M_C":"Lignin_Like")) 
  
#AllChemData_Marchedit_calculatedvalues <- AllChemData_Marchedit %>% 
#  group_by(CowTagID) %>% 
#  summarize(sal_avg = mean(Salinity), 
          #  temp_avg = mean(Temperature), 
          #  TA_avg = mean(TA), 
          #  pH_avg = mean(pH), 
          #  phos_avg = mean(Phosphate_umolL), 
          #  NN_avg = mean(NN_umolL), 
          #  silicate_avg= mean(Silicate_umolL), 
          #  ammonia_avg = mean(Ammonia_umolL), 
          #  sal_max = max(Salinity), 
          # # temp_max = max(Temperature), 
          #  TA_max = max(TA), 
          #  pH_max = max(pH), 
          #  phos_max = max(Phosphate_umolL), 
         #   NN_max = max(NN_umolL), 
          #  silicate_max= max(Silicate_umolL), 
         #   ammonia_max = max(Ammonia_umolL), 
         #   sal_min = min(Salinity), 
          #  temp_min = min(Temperature), 
          #  TA_min = min(TA), 
           # pH_min = min(pH), 
           # phos_min = min(Phosphate_umolL), 
          #  NN_min = min(NN_umolL), 
           # silicate_min= min(Silicate_umolL), 
           # ammonia_min = min(Ammonia_umolL), 
           # sal_CV = ((sd(Salinity)/mean(Salinity))/100), 
          #  temp_CV = ((sd(Temperature)/mean(Temperature))/100), 
          #  TA_CV = ((sd(TA)/mean(TA))/100), 
         #   pH_CV = ((sd(pH)/mean(pH))/100), 
          #  phos_CV = ((sd(Phosphate_umolL)/mean(Phosphate_umolL))/100), 
          #  NN_CV = ((sd(NN_umolL)/mean(NN_umolL))/100), 
          #  silicate_CV= ((sd(Silicate_umolL)/mean(Silicate_umolL))/100), 
          #  ammonia_CV = ((sd(Ammonia_umolL)/mean(Ammonia_umolL))/100))

################# need to summarize recruit totals properly and then join with percent cover data and plot 

RecruitmentCounts2.1 <- RecruitmentCounts %>% 
  group_by(CowTagID, Location) %>% 
  summarise(sum_total = sum(Pocilloporidae+Poritidae+Acroporidae+Other), 
            sum_total_dead = sum(Dead), 
            sum_total_alive=sum(sum_total-sum_total_dead)) %>% 
  write_csv(here::here("Data", "RecruitmentCounts2.1.csv"))

#RecruitmentCounts2 <- RecruitmentCounts %>% 
 # pivot_longer(cols = Pocilloporidae:Other, names_to = "coral_spp", values_to = "recruit_counts")


#RecruitmentCounts3 <- RecruitmentCounts2 %>% 
 # group_by(CowTagID, Location) %>% 
 # summarize(recruit_total= sum(recruit_counts))


## pivot datasets and group together 
#Recruits_pivoted <- RecruitmentCounts %>% 
 # group_by(CowTagID, Location, SGD_level, Side, Dead) %>% 
 # pivot_longer(cols="Pocilloporidae":"Other", names_to = "recruit_counts") %>% 
  #summarize(sum_total=sum(value)) 

#Recruits_pivoted_dead <- RecruitmentCounts %>% 
#  group_by(CowTagID, Location, SGD_level, Side) %>% 
#  pivot_longer(cols="Pocilloporidae":"Other", names_to = "recruit_counts") %>% 
 # summarize(sum_total=sum(value)) 


### getting incorrect values if you FULL, joined dataframe because too many rows per CowTag bc of other data -- fix this -- for right now, using just the recruitment count df 

#totalcounts_tilelocation <- Recruits_pivoted %>% 
 # pivot_wider(names_from = Side, values_from = sum_total) %>% 
 # mutate(total_count = Bottom + Side + Top) ##R recognizes double quotes as characters, so just add the literal column name 


##############
CommComp_recruit <- PercentCover_BinomialSubstrate %>% 
  left_join(RecruitmentCounts2.1, join_by(CowTagID, Location))

CommComp_recruit_seasonavg_envdata <- CommComp_recruit %>% 
  left_join(AllChemDataSeasonAvg_calculatedvalues, join_by(CowTagID)) %>% 
  write_csv(here("Data", "CommComp_recruit_seasonavg_envdata.csv"))


#CommComp_recruit_Augustenvdata <- CommComp_recruit %>% 
#  left_join(AllChemData_Augustedit_calculatedvalues, join_by(CowTagID))

#CommComp_recruit_Marchenvdata <- CommComp_recruit %>% 
#  left_join(AllChemData_Marchedit_calculatedvalues, join_by(CowTagID))


############### 
## separate into individual dfs for both seasons 
## max 
CommComp_recruit_seasonAvg_envdata_longMAX <- CommComp_recruit_seasonavg_envdata %>% 
  pivot_longer(cols="sal_max":"ammonia_max", names_to = "MAXenv_params") %>% 
  mutate(max_value = value) %>% 
  select(!c("sal_avg":"ammonia_CV", "value")) %>% 
  write_csv(here("Data", "longMAX.csv"))

#CommComp_recruit_Marchenvdata_longMAX <- CommComp_recruit_Marchenvdata %>% 
#  pivot_longer(cols="sal_max":"ammonia_max", names_to = "MAXenv_params") %>% 
#  mutate(max_value = value) %>% 
 # select(!c("sal_avg":"ammonia_CV", "value"))

################# 
## min 
CommComp_recruit_seasonAvg_envdata_longMIN <- CommComp_recruit_seasonavg_envdata %>%
  pivot_longer(cols="sal_min":"ammonia_min", names_to = "MINenv_params") %>% 
  mutate(min_value = value) %>% 
  select(!c("sal_avg":"ammonia_CV", "value")) %>% 
  write_csv(here("Data", "longMIN.csv"))

#CommComp_recruit_Marchenvdata_longMIN <- CommComp_recruit_Marchenvdata %>%
#  pivot_longer(cols="sal_min":"ammonia_min", names_to = "MINenv_params") %>% 
 # mutate(min_value = value) %>% 
 # select(!c("sal_avg":"ammonia_CV", "value"))

## mean  
CommComp_recruit_seasonAvg_envdata_longMEAN <- CommComp_recruit_seasonavg_envdata %>% 
  pivot_longer(cols="sal_avg":"ammonia_avg", names_to = "AVGenv_params") %>% 
  mutate(avg_value = value) %>% 
  select(!c("sal_max":"ammonia_CV", "value")) %>% 
  write_csv(here("Data", "longMEAN.csv"))

#CommComp_recruit_Marchenvdata_longMEAN <- CommComp_recruit_Marchenvdata %>% 
#  pivot_longer(cols="sal_avg":"ammonia_avg", names_to = "AVGenv_params") %>% 
#  mutate(avg_value = value) %>% 
#  select(!c("sal_max":"ammonia_CV", "value"))

#### CV 
CommComp_recruit_seasonAvg_envdata_longCV <- CommComp_recruit_seasonavg_envdata %>% 
  pivot_longer(cols="sal_CV":"ammonia_CV", names_to = "CVenv_params") %>% 
  mutate(CV_value = value) %>% 
  select(!c("sal_avg":"ammonia_min", "value")) %>% 
  write_csv(here("Data", "longCV.csv"))

#CommComp_recruit_Marchenvdata_longCV <- CommComp_recruit_Marchenvdata %>% 
 # pivot_longer(cols="sal_CV":"ammonia_CV", names_to = "CVenv_params") %>% 
 # mutate(CV_value = value) %>% 
 # select(!c("sal_avg":"ammonia_min", "value"))
```


# Worked on May 9-10
### calculate CV, mean, max, min of recruit totals per CowTagID ^^^^^^
### also log transform the recruit totals (can do within plot or create new column)
### put logged totals on y-axis, with nutrient data on x-axis 

##### PLOTS these are for MAX VALUES only - for Varari and Cabral per season 
```{r}
## all env params - for Varari 
Recruit_EnvMax_plot <- CommComp_recruit_seasonAvg_envdata_longMAX %>%
#  filter(env_params=="silicate_avg") %>% 
#filter(Location=="Varari") %>% 
  drop_na(sum_total) %>% 
  ggplot(aes(x=max_value, 
             y=log(sum_total+1), 
             color=Location)) +
  geom_point(size=3, shape=21) + 
  geom_smooth(method=lm, formula="y~poly(x,2)") + 
  facet_wrap(Location~MAXenv_params, scales = "free") + 
  theme_bw() + 
  labs(x="value", 
       y="recruit counts", 
       title="Max Values") + 
  theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
  

Recruit_EnvMax_plot
ggsave(here("Outputs","RecruitmentTiles", "CalculatedEnvParams", "Max_averagedenvparams.jpg"), 
       width=20, height=15)

### for March 
#Recruit_EnvMax_March_plot <- CommComp_recruit_Marchenvdata_longMAX %>%
#  filter(env_params=="silicate_avg") %>% 
#filter(Location=="Varari") %>% 
 # drop_na(sum_total) %>% 
 # ggplot(aes(x=max_value, 
           #  y=log(sum_total+1), 
           #  color=Location)) +
# geom_point(size=3, shape=21) + 
 # geom_smooth(method=lm, formula="y~poly(x,2)") + 
#  facet_wrap(Location~MAXenv_params, scales = "free") + 
 # theme_bw() + 
 # labs(x="value", 
     #  y="recruit counts")

#Recruit_EnvMax_March_plot
#ggsave(here("Outputs","RecruitmentTiles", "CalculatedEnvParams", "Marchmax_envparams.jpg"), 
      # width=20, height=15)

```

###### these are for CV VALUES only 
```{r}
Recruit_EnvCV_plot <- CommComp_recruit_seasonAvg_envdata_longCV %>%
#  filter(env_params=="silicate_avg") %>% 
#filter(Location=="Varari") %>% 
  drop_na(sum_total) %>% 
  ggplot(aes(x=CV_value, 
             y=log(sum_total+1), 
             color=Location)) +
  geom_point(size=3, shape=21) + 
  geom_smooth(method=lm, formula="y~poly(x,2)") + 
  facet_wrap(Location~CVenv_params, scales = "free") + 
  theme_bw() + 
  labs(x="value", 
       y="recruit counts", 
       title="CV Values") + 
  theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
Recruit_EnvCV_plot

ggsave(here("Outputs","RecruitmentTiles", "CalculatedEnvParams", "CV_envparams_avg.jpg"), 
       width=20, height=15)


```

###### these are for MEAN VALUES only 
```{r}
Recruit_EnvMean_plot <- CommComp_recruit_seasonAvg_envdata_longMEAN %>%
#  filter(env_params=="silicate_avg") %>% 
#filter(Location=="Varari") %>% 
  drop_na(sum_total) %>% 
  ggplot(aes(x=avg_value, 
             y=log(sum_total+1), 
             color=Location)) +
  geom_point(size=3, shape=21) + 
  #coord_trans(y="log") +
  geom_smooth(method=lm, formula="y~poly(x,2)") + 
  facet_wrap(Location~AVGenv_params, scales = "free") + 
  theme_bw() + 
  labs(x="values",
       y="recruit counts", 
       title="Mean Values") + 
  theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
Recruit_EnvMean_plot

ggsave(here("Outputs","RecruitmentTiles", "CalculatedEnvParams", "Avg_envparams.jpg"), 
       width=20, height=15)

## march 
#Recruit_EnvMean_March_plot <- CommComp_recruit_Marchenvdata_longMEAN %>%
#  filter(env_params=="silicate_avg") %>% 
#filter(Location=="Varari") %>% 
 # drop_na(sum_total) %>% 
 # ggplot(aes(x=avg_value, 
         #    y=log(sum_total+1), 
          #   color=Location)) +
 # geom_point(size=3, shape=21) + 
  #coord_trans(y="log") +
#  geom_smooth(method=lm, formula="y~poly(x,2)") + 
#  facet_wrap(Location~AVGenv_params, scales = "free") + 
#  theme_bw() + 
 # labs(x="value", 
    #   y="recruit counts")
#Recruit_EnvMean_March_plot

#ggsave(here("Outputs","RecruitmentTiles", "CalculatedEnvParams", "Avg_envparams_March.jpg"), 
      # width=20, height=15)
```

###### these are for MIN VALUES only 
```{r}
Recruit_EnvMin_plot <- CommComp_recruit_seasonAvg_envdata_longMIN %>%
#  filter(env_params=="silicate_avg") %>% 
#filter(Location=="Varari") %>% 
  drop_na(sum_total) %>% 
  ggplot(aes(x=min_value, 
             y=log(sum_total+1), 
             color=Location)) +
  geom_point(size=3, shape=21) + 
  #coord_trans(y="log") +
  geom_smooth(method=lm, formula="y~poly(x,2)") + 
  facet_wrap(Location~MINenv_params, scales = "free") + 
  theme_bw() + 
  labs(x="value", 
       y="recruit counts", 
       title="Min Values") + 
  theme(axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        axis.title.x=element_text(size=18),
        axis.title.y=element_text(size=18), 
        plot.title=element_text(hjust=0.5, ## centers title 
                                size=20)) 
Recruit_EnvMin_plot

ggsave(here("Outputs","RecruitmentTiles", "CalculatedEnvParams", "Min_envparams_avgseason.jpg"), 
       width=20, height=15)

## March 
#Recruit_EnvMin_March_plot <- CommComp_recruit_Marchenvdata_longMIN %>%
#  filter(env_params=="silicate_avg") %>% 
#filter(Location=="Varari") %>% 
  #drop_na(sum_total) %>% 
 # ggplot(aes(x=min_value, 
            # y=log(sum_total+1), 
            # color=Location)) +
 # geom_point(size=3, shape=21) + 
  #coord_trans(y="log") +
  #geom_smooth(method=lm, formula="y~poly(x,2)") + 
 # facet_wrap(Location~MINenv_params, scales = "free") + 
 # theme_bw() + 
 # labs(x="value", 
     #  y="recruit counts")
#Recruit_EnvMin_March_plot

#ggsave(here("Outputs","RecruitmentTiles", "CalculatedEnvParams", "Min_envparams_March.jpg"), 
      # width=20, height=15)
```


#### run STATISTICAL models using MEAN values of env data from August and March 
## filtered by site, with ONLY logged values (raw data is not normal)
## and need to do both linear and nonlinear models 

```{r}
## re-pivot the df so each env is individual 
CommComp_recruit_seasonAvg_envdata_wideMEAN <- CommComp_recruit_seasonAvg_envdata_longMEAN %>% 
  pivot_wider(names_from = AVGenv_params, values_from=avg_value)

## individual site dfs 
CommComp_recruit_seasonAvgenvdata_wideMEAN_V <- CommComp_recruit_seasonAvg_envdata_wideMEAN %>% 
  filter(Location=="Varari") %>% 
  drop_na(NN_avg, pH_avg)

CommComp_recruit_seasonAvgenvdata_wideMEAN_C <- CommComp_recruit_seasonAvg_envdata_wideMEAN %>% 
 filter(Location=="Cabral") %>% 
  drop_na(phos_avg, pH_avg, TA_avg)

#######################
## March 
#CommComp_recruit_Marchenvdata_wideMEAN <- CommComp_recruit_Marchenvdata_longMEAN %>% 
#  pivot_wider(names_from = AVGenv_params, values_from=avg_value)

## individual site dfs 
#CommComp_recruit_Marchenvdata_wideMEAN_V <- CommComp_recruit_seasonAvg_envdata_wideMEAN %>% 
# filter(Location=="Varari") %>% 
#  drop_na(NN_avg)

#CommComp_recruit_Marchenvdata_wideMEAN_C <- CommComp_recruit_seasonAvg_envdata_wideMEAN %>% 
 # filter(Location=="Cabral") %>% 
 # drop_na(phos_avg, pH_avg, TA_avg)

####################################################
## models with MEANS with log recruits
####################################################

## NITRATE for Varari linear
meanenv_recruit_linearmodel_NN_V<- lm(log(sum_total+1)~NN_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_linearmodel_NN_V)
AIC(meanenv_recruit_linearmodel_NN_V)

## NITRATE for Varari nonlinear
meanenv_recruit_nonlinearmodel_NN_V <- lm(log(sum_total+1)~poly(NN_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_nonlinearmodel_NN_V)
AIC(meanenv_recruit_nonlinearmodel_NN_V)

## NITRATE for Cabral linear
meanenv_recruit_linearmodel_NN_C <- lm(log(sum_total+1)~NN_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_linearmodel_NN_C)
AIC(meanenv_recruit_linearmodel_NN_C)

## NITRATE for Cabral nonlinear 
meanenv_recruit_nonlinearmodel_NN_C <- lm(log(sum_total+1)~poly(NN_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_nonlinearmodel_NN_C)
AIC(meanenv_recruit_nonlinearmodel_NN_C)

######################################
## PHOSPHATE for Varari linear 
meanenv_recruit_linearmodel_PO4_V <- lm(log(sum_total+1)~phos_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_linearmodel_PO4_V)
AIC(meanenv_recruit_linearmodel_PO4_V)

## PHOSPHATE for Varari nonlinear 
meanenv_recruit_nonlinearmodel_PO4_V <- lm(log(sum_total+1)~poly(phos_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_nonlinearmodel_PO4_V)
AIC(meanenv_recruit_nonlinearmodel_PO4_V)

## PHOSPHATE for Cabral linear 
meanenv_recruit_linearmodel_PO4_C <- lm(log(sum_total+1)~phos_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_linearmodel_PO4_C)
AIC(meanenv_recruit_linearmodel_PO4_C)

## PHOSPHATE for Cabral nonlinear
meanenv_recruit_nonlinearmodel_PO4_C <- lm(log(sum_total+1)~ poly(phos_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_nonlinearmodel_PO4_C)
AIC(meanenv_recruit_nonlinearmodel_PO4_C)

##########################################

## SILICATE for Varari linear 
meanenv_recruit_linearmodel_SiO4_V <- lm(log(sum_total+1)~silicate_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_linearmodel_SiO4_V)
AIC(meanenv_recruit_linearmodel_SiO4_V)

## SILICATE for Varari nonlinear 
meanenv_recruit_nonlinearmodel_SiO4_V2 <- lm(log(sum_total+1)~poly(silicate_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_nonlinearmodel_SiO4_V2)
AIC(meanenv_recruit_nonlinearmodel_SiO4_V2)

## SILICATE for Cabral linear
meanenv_recruit_linearmodel_SiO4_C <- lm(log(sum_total+1)~silicate_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_linearmodel_SiO4_C)
AIC(meanenv_recruit_linearmodel_SiO4_C)

## SILICATE for Cabral nonlinear 
meanenv_recruit_nonlinearmodel_SiO4_C <- lm(log(sum_total+1)~ poly(silicate_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_nonlinearmodel_SiO4_C)
AIC(meanenv_recruit_nonlinearmodel_SiO4_C)

##########################################

## AMMONIA for Varari 
meanenv_recruit_linearmodel_NH4_V <- lm(log(sum_total+1)~ammonia_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_linearmodel_NH4_V)
AIC(meanenv_recruit_linearmodel_NH4_V)

meanenv_recruit_nonlinearmodel_NH4_V <- lm(log(sum_total+1)~poly(ammonia_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_nonlinearmodel_NH4_V)
AIC(meanenv_recruit_nonlinearmodel_NH4_V)


## AMMONIA for Cabral 
meanenv_recruit_linearmodel_NH4_C <- lm(log(sum_total+1)~ammonia_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_linearmodel_NH4_C)
AIC(meanenv_recruit_linearmodel_NH4_C)

meanenv_recruit_nonlinearmodel_NH4_C <- lm(log(sum_total+1)~ poly(ammonia_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_nonlinearmodel_NH4_C)
AIC(meanenv_recruit_nonlinearmodel_NH4_C)

##########################################

## PH for Varari 
meanenv_recruit_linearmodel_pH_V <- lm(log(sum_total+1)~pH_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_linearmodel_pH_V)
AIC(meanenv_recruit_linearmodel_pH_V)

meanenv_recruit_nonlinearmodel_pH_V <- lm(log(sum_total+1)~poly(pH_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_nonlinearmodel_pH_V)
AIC(meanenv_recruit_nonlinearmodel_pH_V)

## PH for Cabral 
meanenv_recruit_linearmodel_pH_C <- lm(log(sum_total+1)~pH_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_linearmodel_pH_C)
AIC(meanenv_recruit_linearmodel_pH_C)


meanenv_recruit_nonlinearmodel_pH_C2 <- lm(log(sum_total+1)~ poly(pH_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_nonlinearmodel_pH_C2)
AIC(meanenv_recruit_nonlinearmodel_pH_C2)


##########################################

## SALINITY for Varari 
meanenv_recruit_linearmodel_salinity_V <- lm(log(sum_total+1)~sal_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_linearmodel_salinity_V)
AIC(meanenv_recruit_linearmodel_salinity_V)

meanenv_recruit_nonlinearmodel_salinity_V <- lm(log(sum_total+1)~poly(sal_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_nonlinearmodel_salinity_V)
AIC(meanenv_recruit_nonlinearmodel_salinity_V)


## SALINITY for Cabral 
meanenv_recruit_linearmodel_salinity_C <- lm(log(sum_total+1)~sal_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_linearmodel_salinity_C)
AIC(meanenv_recruit_linearmodel_salinity_C)

meanenv_recruit_nonlinearmodel_salinity_C <- lm(log(sum_total+1)~ poly(sal_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_nonlinearmodel_salinity_C)
AIC(meanenv_recruit_nonlinearmodel_salinity_C)

##########################################

## TA for Varari 

meanenv_recruit_linearmodel_TA_V <- lm(log(sum_total+1)~TA_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_linearmodel_TA_V)
AIC(meanenv_recruit_linearmodel_TA_V)

meanenv_recruit_nonlinearmodel_TA_V <- lm(log(sum_total+1)~poly(TA_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_nonlinearmodel_TA_V)
AIC(meanenv_recruit_nonlinearmodel_TA_V)


## TA for Cabral 
meanenv_recruit_linearmodel_TA_C <- lm(log(sum_total+1)~TA_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_linearmodel_TA_C)
AIC(meanenv_recruit_linearmodel_TA_C)

meanenv_recruit_nonlinearmodel_TA_C <- lm(log(sum_total+1)~ poly(TA_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_nonlinearmodel_TA_C)
AIC(meanenv_recruit_nonlinearmodel_TA_C)



##########################################
## TEMP for Varari 
meanenv_recruit_linearmodel_temp_V <- lm(log(sum_total+1)~temp_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_linearmodel_temp_V)
AIC(meanenv_recruit_linearmodel_temp_V)

meanenv_recruit_nonlinearmodel_temp_V <- lm(log(sum_total+1)~poly(temp_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_V)
summary(meanenv_recruit_nonlinearmodel_temp_V)
AIC(meanenv_recruit_nonlinearmodel_temp_V)

## TEMP for Cabral
meanenv_recruit_linearmodel_temp_C <- lm(log(sum_total+1)~temp_avg, data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_linearmodel_temp_C)
AIC(meanenv_recruit_linearmodel_temp_C)


meanenv_recruit_nonlinearmodel_temp_C <- lm(log(sum_total+1)~ poly(temp_avg, degree=2), data=CommComp_recruit_seasonAvgenvdata_wideMEAN_C)
summary(meanenv_recruit_nonlinearmodel_temp_C)
AIC(meanenv_recruit_nonlinearmodel_temp_C)

```

#### run STATISTICAL models using MIN values of env data 
## filtered by site, with and without logged values 
## dont count unlogged - because raw data is not normal 

```{r}
## re-pivot the df so each env is individual 
CommComp_recruit_envdata_wideMIN <- CommComp_recruit_envdata_longMIN %>% 
  pivot_wider(names_from = MINenv_params, values_from=min_value)

CommComp_recruit_envdata_wideMIN_V <- CommComp_recruit_envdata_wideMIN %>% 
  filter(Location=="Varari") %>% 
  drop_na(NN_min)

CommComp_recruit_envdata_wideMIN_C <- CommComp_recruit_envdata_wideMIN %>% 
  filter(Location=="Cabral") %>% 
  drop_na(phos_min, pH_min, TA_min)

####################################################
## models with means withOUT log recruits
####################################################

## NITRATE for Varari  
minenv_recruit_model_NN_V <- lm(sum_total~poly(NN_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_NN_V)

minenv_recruit_model_NN_V2 <- lm(log(sum_total+1)~poly(NN_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_NN_V2)

## NITRATE for Cabral  
minenv_recruit_model_NN_C <- lm(sum_total~poly(NN_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_NN_C)

minenv_recruit_model_NN_C2 <- lm(log(sum_total+1)~poly(NN_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_NN_C2)

######################################
## PHOSPHATE for Varari
minenv_recruit_model_PO4_V <- lm(sum_total~poly(phos_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_NN_C2)

minenv_recruit_model_PO4_V2 <- lm(log(sum_total+1)~poly(phos_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_PO4_V2)


## PHOSPHATE for Cabral
minenv_recruit_model_PO4_C <- lm(sum_total~poly(phos_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_PO4_C)

minenv_recruit_model_PO4_C2 <- lm(log(sum_total+1)~ poly(phos_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_PO4_C2)

##########################################

## SILICATE for Varari 
minenv_recruit_model_SiO4_V <- lm(sum_total~poly(silicate_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_SiO4_V)

minenv_recruit_model_SiO4_V2 <- lm(log(sum_total+1)~poly(silicate_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_SiO4_V2)

## SILICATE for Cabral 
minenv_recruit_model_SiO4_C <- lm(sum_total~poly(silicate_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_SiO4_C)

minenv_recruit_model_SiO4_C2 <- lm(log(sum_total+1)~ poly(silicate_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_SiO4_C2)

##########################################

## AMMONIA for Varari 
minenv_recruit_model_NH4_V <- lm(sum_total~poly(ammonia_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_NH4_V)

minenv_recruit_model_NH4_V2 <- lm(log(sum_total+1)~poly(ammonia_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_NH4_V2)


## AMMONIA for Cabral 
minenv_recruit_model_NH4_C <- lm(sum_total~poly(ammonia_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_NH4_C)

minenv_recruit_model_NH4_C2 <- lm(log(sum_total+1)~ poly(ammonia_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_NH4_C2)

##########################################

## PH for Varari 
minenv_recruit_model_pH_V <- lm(sum_total~poly(pH_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_pH_V)

minenv_recruit_model_pH_V2 <- lm(log(sum_total+1)~poly(pH_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_pH_V2)

## PH for Cabral 
minenv_recruit_model_pH_C <- lm(sum_total~poly(pH_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_pH_C)

minenv_recruit_model_pH_C2 <- lm(log(sum_total+1)~ poly(pH_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_pH_C2)


##########################################

## SALINITY for Varari 
minenv_recruit_model_salinity_V <- lm(sum_total~poly(sal_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_salinity_V)

minenv_recruit_model_salinity_V2 <- lm(log(sum_total+1)~poly(sal_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_salinity_V2)


## SALINITY for Cabral 
minenv_recruit_model_salinity_C <- lm(sum_total~poly(sal_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_salinity_C)

minenv_recruit_model_salinity_C2 <- lm(log(sum_total+1)~ poly(sal_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_salinity_C2)

##########################################

## TA for Varari 

minenv_recruit_model_TA_V <- lm(sum_total~poly(TA_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_TA_V)

minenv_recruit_model_TA_V2 <- lm(log(sum_total+1)~poly(TA_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_TA_V2)


## TA for Cabral 
minenv_recruit_model_TA_C <- lm(sum_total~poly(TA_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_TA_C)

minenv_recruit_model_TA_C2 <- lm(log(sum_total+1)~ poly(TA_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_TA_C2)

##########################################
## TEMP for Varari 
minenv_recruit_model_temp_V <- lm(sum_total~poly(temp_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_temp_V)

minenv_recruit_model_temp_V2 <- lm(log(sum_total+1)~poly(temp_min, degree=2), data=CommComp_recruit_envdata_wideMIN_V)
summary(minenv_recruit_model_temp_V2)

## TEMP for Cabral
minenv_recruit_model_temp_C <- lm(sum_total~poly(temp_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_temp_C)

minenv_recruit_model_temp_C2 <- lm(log(sum_total+1)~ poly(temp_min, degree=2), data=CommComp_recruit_envdata_wideMIN_C)
summary(minenv_recruit_model_temp_C2)
```


#### run STATISTICAL models using MAX values of env data 
## filtered by site, with only logged values 

```{r}
## re-pivot the df so each env is individual 
CommComp_recruit_envdata_wideMAX <- CommComp_recruit_envdata_longMAX %>% 
  pivot_wider(names_from = MAXenv_params, values_from=max_value)

CommComp_recruit_envdata_wideMAX_V <- CommComp_recruit_envdata_wideMAX %>% 
  filter(Location=="Varari") %>% 
  drop_na(NN_max)

CommComp_recruit_envdata_wideMAX_C <- CommComp_recruit_envdata_wideMAX %>% 
  filter(Location=="Cabral") %>% 
  drop_na(phos_max, pH_max, TA_max)

####################################################
## models with means with log recruits
####################################################

## NITRATE for Varari  
maxenv_recruit_model_NN_V2 <- lm(log(sum_total+1)~poly(NN_max, degree=2), data=CommComp_recruit_envdata_wideMAX_V)
summary(maxenv_recruit_model_NN_V2)

## NITRATE for Cabral  
maxenv_recruit_model_NN_C2 <- lm(log(sum_total+1)~poly(NN_max, degree=2), data=CommComp_recruit_envdata_wideMAX_C)
summary(maxenv_recruit_model_NN_C2)

######################################
## PHOSPHATE for Varari
maxenv_recruit_model_PO4_V2 <- lm(log(sum_total+1)~poly(phos_max, degree=2), data=CommComp_recruit_envdata_wideMAX_V)
summary(maxenv_recruit_model_PO4_V2)

## PHOSPHATE for Cabral
maxenv_recruit_model_PO4_C2 <- lm(log(sum_total+1)~ poly(phos_max, degree=2), data=CommComp_recruit_envdata_wideMAX_C)
summary(maxenv_recruit_model_PO4_C2)

##########################################
## SILICATE for Varari 
maxenv_recruit_model_SiO4_V2 <- lm(log(sum_total+1)~poly(silicate_max, degree=2), data=CommComp_recruit_envdata_wideMAX_V)
summary(maxenv_recruit_model_SiO4_V2)

## SILICATE for Cabral 
maxenv_recruit_model_SiO4_C2 <- lm(log(sum_total+1)~ poly(silicate_max, degree=2), data=CommComp_recruit_envdata_wideMAX_C)
summary(maxenv_recruit_model_SiO4_C2)

##########################################
## AMMONIA for Varari 
maxenv_recruit_model_NH4_V2 <- lm(log(sum_total+1)~poly(ammonia_max, degree=2), data=CommComp_recruit_envdata_wideMAX_V)
summary(maxenv_recruit_model_NH4_V2)


## AMMONIA for Cabral 
maxenv_recruit_model_NH4_C2 <- lm(log(sum_total+1)~ poly(ammonia_max, degree=2), data=CommComp_recruit_envdata_wideMAX_C)
summary(maxenv_recruit_model_NH4_C2)

##########################################
## PH for Varari 
maxenv_recruit_model_pH_V2 <- lm(log(sum_total+1)~poly(pH_max, degree=2), data=CommComp_recruit_envdata_wideMAX_V)
summary(maxenv_recruit_model_pH_V2)

## PH for Cabral 
maxenv_recruit_model_pH_C2 <- lm(log(sum_total+1)~ poly(pH_max, degree=2), data=CommComp_recruit_envdata_wideMAX_C)
summary(maxenv_recruit_model_pH_C2)

##########################################

## SALINITY for Varari 
maxenv_recruit_model_salinity_V2 <- lm(log(sum_total+1)~poly(sal_max, degree=2), data=CommComp_recruit_envdata_wideMAX_V)
summary(maxenv_recruit_model_salinity_V2)

## SALINITY for Cabral 
maxenv_recruit_model_salinity_C2 <- lm(log(sum_total+1)~ poly(sal_max, degree=2), data=CommComp_recruit_envdata_wideMAX_C)
summary(maxenv_recruit_model_salinity_C2)

##########################################
## TA for Varari 
maxenv_recruit_model_TA_V2 <- lm(log(sum_total+1)~poly(TA_max, degree=2), data=CommComp_recruit_envdata_wideMAX_V)
summary(maxenv_recruit_model_TA_V2)

## TA for Cabral 
maxenv_recruit_model_TA_C2 <- lm(log(sum_total+1)~ poly(TA_max, degree=2), data=CommComp_recruit_envdata_wideMAX_C)
summary(maxenv_recruit_model_TA_C2)

##########################################
## TEMP for Varari 
maxenv_recruit_model_temp_V2 <- lm(log(sum_total+1)~poly(temp_max, degree=2), data=CommComp_recruit_envdata_wideMAX_V)
summary(maxenv_recruit_model_temp_V2)

## TEMP for Cabral
maxenv_recruit_model_temp_C2 <- lm(log(sum_total+1)~ poly(temp_max, degree=2), data=CommComp_recruit_envdata_wideMAX_C)
summary(maxenv_recruit_model_temp_C2)
```


#### run STATISTICAL models using CV values of env data 
## filtered by site, with only logged values 

```{r}
## re-pivot the df so each env is individual 
CommComp_recruit_envdata_wideCV <- CommComp_recruit_envdata_longCV %>% 
  pivot_wider(names_from = CVenv_params, values_from=CV_value)

CommComp_recruit_envdata_wideCV_V <- CommComp_recruit_envdata_wideCV %>% 
  filter(Location=="Varari") %>% 
  drop_na(NN_CV)

CommComp_recruit_envdata_wideCV_C <- CommComp_recruit_envdata_wideCV %>% 
  filter(Location=="Cabral") %>% 
  drop_na(phos_CV, pH_CV, TA_CV)

####################################################
## models with means with log recruits
####################################################

## NITRATE for Varari  
CVenv_recruit_model_NN_V2 <- lm(log(sum_total+1)~poly(NN_CV, degree=2), data=CommComp_recruit_envdata_wideCV_V)
summary(CVenv_recruit_model_NN_V2)

## NITRATE for Cabral  
CVenv_recruit_model_NN_C2 <- lm(log(sum_total+1)~poly(NN_CV, degree=2), data=CommComp_recruit_envdata_wideCV_C)
summary(CVenv_recruit_model_NN_C2)

######################################
## PHOSPHATE for Varari
CVenv_recruit_model_PO4_V2 <- lm(log(sum_total+1)~poly(phos_CV, degree=2), data=CommComp_recruit_envdata_wideCV_V)
summary(CVenv_recruit_model_PO4_V2)

## PHOSPHATE for Cabral
CVenv_recruit_model_PO4_C2 <- lm(log(sum_total+1)~ poly(phos_CV, degree=2), data=CommComp_recruit_envdata_wideCV_C)
summary(CVenv_recruit_model_PO4_C2)

##########################################
## SILICATE for Varari 
CVenv_recruit_model_SiO4_V2 <- lm(log(sum_total+1)~poly(silicate_CV, degree=2), data=CommComp_recruit_envdata_wideCV_V)
summary(CVenv_recruit_model_SiO4_V2)

## SILICATE for Cabral 
CVenv_recruit_model_SiO4_C2 <- lm(log(sum_total+1)~ poly(silicate_CV, degree=2), data=CommComp_recruit_envdata_wideCV_C)
summary(CVenv_recruit_model_SiO4_C2)

##########################################
## AMMONIA for Varari 
CVenv_recruit_model_NH4_V2 <- lm(log(sum_total+1)~poly(ammonia_CV, degree=2), data=CommComp_recruit_envdata_wideCV_V)
summary(CVenv_recruit_model_NH4_V2)

## AMMONIA for Cabral 
CVenv_recruit_model_NH4_C2 <- lm(log(sum_total+1)~ poly(ammonia_CV, degree=2), data=CommComp_recruit_envdata_wideCV_C)
summary(CVenv_recruit_model_NH4_C2)

##########################################
## PH for Varari 
CVenv_recruit_model_pH_V2 <- lm(log(sum_total+1)~poly(pH_CV, degree=2), data=CommComp_recruit_envdata_wideCV_V)
summary(CVenv_recruit_model_pH_V2)

## PH for Cabral 
CVenv_recruit_model_pH_C2 <- lm(log(sum_total+1)~ poly(pH_CV, degree=2), data=CommComp_recruit_envdata_wideCV_C)
summary(CVenv_recruit_model_pH_C2)

##########################################

## SALINITY for Varari 
CVenv_recruit_model_salinity_V2 <- lm(log(sum_total+1)~poly(sal_CV, degree=2), data=CommComp_recruit_envdata_wideCV_V)
summary(CVenv_recruit_model_salinity_V2)

## SALINITY for Cabral 
CVenv_recruit_model_salinity_C2 <- lm(log(sum_total+1)~ poly(sal_CV, degree=2), data=CommComp_recruit_envdata_wideCV_C)
summary(CVenv_recruit_model_salinity_C2)

##########################################
## TA for Varari 
CVenv_recruit_model_TA_V2 <- lm(log(sum_total+1)~poly(TA_CV, degree=2), data=CommComp_recruit_envdata_wideCV_V)
summary(CVenv_recruit_model_TA_V2)

## TA for Cabral 
CVenv_recruit_model_TA_C2 <- lm(log(sum_total+1)~ poly(TA_CV, degree=2), data=CommComp_recruit_envdata_wideCV_C)
summary(CVenv_recruit_model_TA_C2)

##########################################
## TEMP for Varari 
CVenv_recruit_model_temp_V2 <- lm(log(sum_total+1)~poly(temp_CV, degree=2), data=CommComp_recruit_envdata_wideCV_V)
summary(CVenv_recruit_model_temp_V2)

## TEMP for Cabral
CVenv_recruit_model_temp_C2 <- lm(log(sum_total+1)~ poly(temp_CV, degree=2), data=CommComp_recruit_envdata_wideCV_C)
summary(CVenv_recruit_model_temp_C2)
```




###################################################################
###################################################################


###### these are for MIN VALUES only 
```{r}
Recruit_EnvMin_plot <- CommComp_recruit_envdata_longMIN %>%
#  filter(env_params=="silicate_avg") %>% 
#filter(Location=="Varari") %>% 
  drop_na(sum_total) %>% 
  ggplot(aes(x=min_value, 
             y=log(sum_total+1), 
             color=Location)) +
  geom_point(size=3, shape=21) + 
  geom_smooth(method=lm, formula="y~poly(x,2)") + 
  facet_wrap(Location~MINenv_params, scales = "free") + 
  theme_bw() + 
  labs(x="value", 
       y="recruit counts")
Recruit_EnvMin_plot

ggsave(here("Outputs","RecruitmentTiles", "Min_envparams.jpg"), 
       width=20, height=15)


```

###################################################################
###################################################################

#### compare live and dead recruits (last updated May 14th) 
```{r}
CommComp_recruit_envdata_pivot <- CommComp_recruit_envdata %>%
  pivot_longer(cols = sum_total_alive:sum_total_dead, names_to = "Dead_Alive", values_to = "Total")
  
  
  
live_dead_plotC <- CommComp_recruit_envdata_pivot %>% 
  filter(Location=="Cabral") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20", "CSEEP")), 
             y=Total, 
             fill=Dead_Alive)) + 
  geom_bar(position = "dodge", stat="identity") + 
  scale_fill_manual(values=c("coral2", "darkgray"), 
                    guide="none") + 
  labs(x="Cabral CowTag IDs")

live_dead_plotC

live_dead_plotV <- CommComp_recruit_envdata_pivot %>% 
  filter(Location=="Varari") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12", "V13", "V14", "V15", "V16", "V17", "V18", "V19", "V20", "VSEEP")), 
             y=Total, 
             fill=Dead_Alive)) + 
  geom_bar(position = "dodge", stat="identity") + 
  scale_fill_manual(values=c("coral2", "darkgray"), 
                    guide="none") + 
  labs(x="Varari CowTag IDs")

live_dead_plotV

DeadvsAlive <- live_dead_plotV + live_dead_plotC 
DeadvsAlive

ggsave(here("Outputs","RecruitmentTiles", "Dead_vs_Alive.jpg"), 
       width=20, height=15)




############### as stacked bar plot 
live_dead_plotV2 <- CommComp_recruit_envdata_pivot %>% 
  filter(Location=="Varari") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12", "V13", "V14", "V15", "V16", "V17", "V18", "V19", "V20", "VSEEP")), 
             y=Total, 
             fill=Dead_Alive)) + 
  geom_col() + 
  scale_fill_manual(values=c("coral2", "darkgray"), 
                    guide="none") + 
  labs(x="Varari CowTag IDs")
live_dead_plotV2


live_dead_plotC2 <- CommComp_recruit_envdata_pivot %>% 
  filter(Location=="Cabral") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20", "CSEEP")), 
             y=Total, 
             fill=Dead_Alive)) + 
  geom_col() + 
  scale_fill_manual(values=c("coral2", "darkgray"), 
                    guide="none") + 
  labs(x="Cabral CowTag IDs")
live_dead_plotC2

live_dead_plotC2 + live_dead_plotV2
ggsave(here("Outputs","RecruitmentTiles", "Dead_vs_Alive_stacked.jpg"), 
       width=20, height=15)


###############################
### now look at this by different env parameters 
###############################


CommComp_recruit_envdata_pivot_edit <- CommComp_recruit_envdata_pivot %>% 
  select(!c(sal_max:ammonia_CV))

EnvData_DeadAliveC <- CommComp_recruit_envdata_pivot_edit %>% 
  filter(Location=="Cabral", 
         silicate_avg < 40) %>%
  ggplot(aes(x=silicate_avg, 
             y=log(Total+1), 
             color=Dead_Alive)) + 
  geom_point(size=4) + 
  geom_smooth(method= lm, formula="y~poly(x,2)") + 
  scale_color_manual(values=c("coral2", "darkgray"), 
                    guide="none") + 
   labs(x="Cabral Silicate") 

EnvData_DeadAliveC

  
EnvData_DeadAliveV <- CommComp_recruit_envdata_pivot_edit %>% 
  filter(Location=="Varari", 
         silicate_avg < 40) %>% 
  ggplot(aes(x=silicate_avg, 
             y=log(Total+1), 
             color=Dead_Alive)) + 
  geom_point(size=4) + 
  geom_smooth(method= lm, formula="y~poly(x,2)") +
  scale_color_manual(values=c("coral2", "darkgray"), 
                    guide="none") + 
  labs(x="Varari Silicate")

EnvData_DeadAliveV

Dead_Alive_EnvData <- EnvData_DeadAliveV + EnvData_DeadAliveC
ggsave(here("Outputs","RecruitmentTiles", "Dead_vs_Alive_EnvData.jpg"), 
       width=15, height=10)

```


#### plot the dead vs alive as scatterplot with 0 slope 
#### then also calculate the actual slope and residuals using *regression* model and see how compares to a 0 slope 
```{r}
### color by silicate 
CommComp_recruit_envdata2 <- CommComp_recruit_envdata %>% 
  select(!c("sal_max":"ammonia_CV"))

Dead_Alive_Scatter_slope1 <- CommComp_recruit_envdata2 %>% 
  filter(silicate_avg < 40) %>% 
  ggplot(aes(y=log(sum_total_alive+1), 
             x=log(sum_total_dead+1), 
             color=silicate_avg)) + 
  geom_point(size=4) + 
  scale_color_viridis() +
  geom_abline(slope = 1, intercept=0) +
 # geom_abline(slope = 1.086, intercept=0, linetype=2) + 
#  geom_ribbon(aes(ymin=1.086-0.2147, ymax=1.086+0.2147)) + FIGURE OUT HOW TO GET SE BARS 
  facet_wrap(~Location) 
  
Dead_Alive_Scatter_slope1
ggsave(here("Outputs","RecruitmentTiles", "Dead_Alive_Scatter_slope1.jpg"), 
       width=10, height=8)

################################
### should separate by site though because Cabral and Varari are different 
################################
CommComp_recruit_envdata2_Cabral <- CommComp_recruit_envdata2 %>% 
  filter(Location=="Cabral") %>% 
  mutate(log_alive=log(sum_total_alive+1), 
         log_dead=log(sum_total_dead+1))

CommComp_recruit_envdata2_Varari <- CommComp_recruit_envdata2 %>% 
  filter(Location=="Varari") %>% 
  mutate(log_alive=log(sum_total_alive+1), 
         log_dead=log(sum_total_dead+1))

################################
## calculate the slope and regression and residuals and plot of all those things 
################################
## model 
dead_alive_model_Cabral <- lm(log_alive~ log_dead, data=CommComp_recruit_envdata2_Cabral)
## ^ make sure that alive is first, because not it is switched to be on the y-axis bc easier to visualize values 

dead_alive_model_Cabral ### gives you new intercept and slope 
anova(dead_alive_model_Cabral)
summary(dead_alive_model_Cabral)

####################
dead_alive_model_Varari <- lm(log_alive ~ log_dead, data=CommComp_recruit_envdata2_Varari)

dead_alive_model_Varari
anova(dead_alive_model_Varari) 
summary(dead_alive_model_Varari)


#############################
## run a model with both sites just to prove that there is a difference by site 
#############################
dead_alive_model_bothsites <- lm(log(sum_total_alive+1) ~ log(sum_total_dead+1)*Location, data=CommComp_recruit_envdata2)

anova(dead_alive_model_bothsites) ### IF LOGGED: due to density dependence there is NO significant relationship --> big diff in intercepts 
summary(dead_alive_model_bothsites)
plot(dead_alive_model_bothsites)
dead_alive_model_bothsites ## gives you the slope and intercept if you just type it out 

### BUT if do NOT log the data 
dead_alive_model_bothsites_nolog <- lm(sum_total_alive ~ sum_total_dead*Location, data=CommComp_recruit_envdata2)

anova(dead_alive_model_bothsites_nolog) ### IF NOT logged: STRONG significant relationship --> big diff in intercepts 
summary(dead_alive_model_bothsites_nolog)
plot(dead_alive_model_bothsites_nolog)
dead_alive_model_bothsites_nolog

```

#### plot as independent sites with regular slope of 1 and calculated slope 
```{r}
########## 
Cabral_DeadAlive <- CommComp_recruit_envdata2_Cabral %>% 
  filter(silicate_avg < 40) %>% 
  ggplot(aes(y=log_alive, 
             x=log_dead, 
             color=silicate_avg)) + 
  geom_point(size=4) + 
  scale_color_viridis() +
  geom_abline(slope = 1, intercept=0) +
 geom_abline(slope = 0.7420, intercept=0, linetype=2) + 
  labs(title="Cabral")
#  geom_ribbon(aes(ymin=1.086-0.2147, ymax=1.086+0.2147)) + FIGURE OUT HOW TO GET SE BARS 
 # facet_wrap(~Location) 
Cabral_DeadAlive

ggsave(here("Outputs","RecruitmentTiles", "Cabral_DeadAlive_slopes.jpg"), 
       width=10, height=8)

#############
Varari_DeadAlive <- CommComp_recruit_envdata2_Varari %>% 
  filter(silicate_avg < 40) %>% 
  ggplot(aes(y=log_alive, 
             x=log_dead, 
             color=silicate_avg)) + 
  geom_point(size=4) + 
  scale_color_viridis(guide="none") +
  geom_abline(slope = 1, intercept=0) +
 geom_abline(slope = 0.6563, intercept=0, linetype=2) + 
  labs(title="Varari")
  
#  geom_ribbon(aes(ymin=1.086-0.2147, ymax=1.086+0.2147)) + FIGURE OUT HOW TO GET SE BARS 
 # facet_wrap(~Location) 
Varari_DeadAlive

ggsave(here("Outputs","RecruitmentTiles", "Varari_DeadAlive_slopes.jpg"), 
       width=10, height=8)

##################
## compare both sites next to each other 

Varari_DeadAlive + Cabral_DeadAlive
ggsave(here("Outputs","RecruitmentTiles", "DeadAlive_slopes_bothsites.jpg"), 
       width=10, height=8)


```


### calculate residuals  
```{r}
### calculate the difference from 1:1 line and the raw data slope of 1.086 to calculate resids 
## then take resid as response var and silicate on x axis 

##################################
##### not using this code below anymore because want to split per site BUT if want to use both sites together, can uncomment below. 
################################### 
#CommComp_recruit_envdata3 <- CommComp_recruit_envdata2 %>% 
  #add_residuals(dead_alive_model) %>%  ## using the modelr package to compare to the actual calculations below 
  #mutate(resids=((sum_total_dead)-(((1.086)*(sum_total_alive)) + (6.599))))  
### YAY GOOD JOB HANNAH FOR UNDERSTANDING STATS AND FIGURING IT OUT WITHOUT ASKING QUESTIONS 

##################################
### residual = actual y - predicted y --> y= mx + b where m is slope, x is alive/dead recruits, and b is intercept from models 
##################################
####  RESIDUALS ARE CALCULATED USING LOG DATA FOR THESE DFS 

### for Cabral 
Cabral_resids_dataslope <- CommComp_recruit_envdata2_Cabral %>% 
  mutate(resids=((log_alive)-((0.7420*log_alive) + 0))) ### use the slope calculated from the models 
         
Cabral_resids_slope1 <- CommComp_recruit_envdata2_Cabral %>% 
  mutate(resids=((log_alive)-((1*log_alive) + 0))) #### THIS IS JUST 0 THEN -- ASK NYSSA 

### for Varari 
Varari_resids_dataslope <- CommComp_recruit_envdata2_Varari %>% 
 mutate(resids=((log_alive)-((0.6563*log_alive) + 0)))

Varari_resids_slope1 <- CommComp_recruit_envdata2_Varari %>% 
  mutate(resids=((log_alive)-((1*log_alive) + 0)))

```

### plot residuals 
```{r}
## and plot with slope from data 
Dead_Alive_resid_Cabral <- Cabral_resids_dataslope %>% 
  filter(silicate_avg < 40) %>% 
  ggplot(aes(x=silicate_avg, 
             y=resids)) + 
  geom_point(size=4) +
  facet_wrap(~Location, scales="free") 

Dead_Alive_resid_Cabral
ggsave(here("Outputs","RecruitmentTiles", "DeadAlive_resids_Cabral.jpg"), 
       width=10, height=8)

##### with slope of 1
Dead_Alive_resid_Cabral2 <- Cabral_resids_slope1 %>% 
  filter(silicate_avg < 40) %>% 
  ggplot(aes(x=silicate_avg, 
             y=resids)) + 
  geom_point(size=4) +
  facet_wrap(~Location, scales="free") 

Dead_Alive_resid_Cabral2
ggsave(here("Outputs","RecruitmentTiles", "DeadAlive_0resids_Cabral.jpg"), 
       width=10, height=8)


Dead_Alive_resid_Cabral2 + Dead_Alive_resid_Cabral
ggsave(here("Outputs","RecruitmentTiles", "DeadAlive_Cabral_residscombined.jpg"), 
       width=10, height=8)

#########################
### For Varari 
#########################
Dead_Alive_resid_Varari <- Varari_resids_dataslope %>% 
  filter(silicate_avg < 40) %>% 
  ggplot(aes(x=silicate_avg, 
             y=resids)) + 
  geom_point(size=4) +
  facet_wrap(~Location, scales="free") 

Dead_Alive_resid_Varari
ggsave(here("Outputs","RecruitmentTiles", "DeadAlive_resids_Varari.jpg"), 
       width=10, height=8)

#####
Dead_Alive_resid_Varari2 <- Varari_resids_slope1 %>% 
  filter(silicate_avg < 40) %>% 
  ggplot(aes(x=silicate_avg, 
             y=resids)) + 
  geom_point(size=4) +
  facet_wrap(~Location, scales="free") 

Dead_Alive_resid_Varari2
ggsave(here("Outputs","RecruitmentTiles", "DeadAlive_resids0_Varari.jpg"), 
       width=10, height=8)

##############################
## combine two sites with residuals based on data 
##############################

Dead_Alive_resid_Varari + Dead_Alive_resid_Cabral
ggsave(here("Outputs","RecruitmentTiles", "DeadAlive_resids_bothsites.jpg"), 
       width=10, height=8)

```


### run models on residuals 
```{r}
############################
## Varari resid models 
############################

V_resid_model1 <- lm(resids~silicate_avg, data=Varari_resids_dataslope)

anova(V_resid_model1)

```




NOTES: 
## impact of GW is on total # of recruits getting to plate AND who stays alive/dies - more are surviving than expected ## this is a log process bc density dependence 
#### do each env parameters affect the expected relationship from dead vs alive 

###################################################################
###################################################################

NEXT SECTION 
#### do percent cover comparison 

```{r}
SubstratePref <- PercentCover_BinomialSubstrate %>% 
  full_join(totalcounts_tilelocation, join_by(CowTagID, Location)) %>% 
  select(!(SGD_level)) %>% 
  pivot_longer(cols = Sand:HardSubstrate, values_to = "Values") %>% 
  mutate(substrate=name) %>% 
  select(!(name))

SubstrateBreakdown_plotC <- SubstratePref %>% 
  filter(Location=="Cabral") %>% 
  ggplot(aes(x=CowTagID,
             y=Values, 
             fill=substrate)) + 
  geom_col()+ 
  scale_fill_manual(values = c("coral2", "burlywood"), 
                    guide="none")  + 
  theme(axis.text.x = element_text(angle = 45)) + 
  labs(x="Cabral")
 # facet_wrap(~Location)

SubstrateBreakdown_plotC

####
SubstrateBreakdown_plotV <- SubstratePref %>% 
  filter(Location=="Varari") %>% 
  ggplot(aes(x=CowTagID,
             y=Values, 
             fill=substrate)) + 
  geom_col()+ 
  scale_fill_manual(values = c("coral2", "burlywood"), 
                    guide="none")  + 
  theme(axis.text.x = element_text(angle = 45)) + 
  labs(x="Varari")
 # facet_wrap(~Location)

SubstrateBreakdown_plotV

JointSite_Substrate <- SubstrateBreakdown_plotV + SubstrateBreakdown_plotC
JointSite_Substrate


###############
SubstratePreference_plotC <- SubstratePref %>% 
  filter(Location=="Cabral") %>% 
  ggplot(aes(x=CowTagID,
             y=total_count, 
             fill=Location)) + 
  geom_col()+ 
  scale_fill_manual(values = "darkgreen", 
                    guide="none") + 
  theme(axis.text.x = element_text(angle = 45))
  
Cabral_RecruitsSubs <- SubstratePreference_plotC + SubstrateBreakdown_plotC
Cabral_RecruitsSubs


ggsave(here("Outputs","RecruitmentTiles", "CabralRecruits_Substrate.jpg"), 
       width=20, height=15)


####
SubstratePreference_plotV <- SubstratePref %>% 
  filter(Location=="Varari") %>% 
  ggplot(aes(x=CowTagID,
             y=total_count, 
             fill=Location)) + 
  geom_col()+ 
  scale_fill_manual(values = "gold2", 
                 guide="none") + 
  theme(axis.text.x = element_text(angle = 45))
  
SubstratePreference_plotV


Vararai_RecruitsSubs <- SubstratePreference_plotV + SubstrateBreakdown_plotV
Vararai_RecruitsSubs

ggsave(here("Outputs","RecruitmentTiles", "VarariRecruits_Substrate.jpg"), 
       width=20, height=15)

```






###########################################################################################
## Old plots April 2024 

## these plots show rough SGD estimate, taken from silicate kriging plot with total recruit counts per plate 

```{r}
## try to plot basics for Varari 
### this plot 
Recruits_by_SGD_level_V <- totalcounts_tilelocation %>% 
  filter(Location=="Varari") %>% 
  ggplot(aes(x=reorder(CowTagID, -total_count), 
             y=total_count, 
             fill=SGD_level)) + 
  geom_col() + 
  theme_blank()  + 
  scale_fill_manual(values=c("darkseagreen4", "darkgoldenrod2", "coral4"), 
                    limits=c("Low", "Mid", "High")) + 
   labs(title="Varari", 
       x="CowTag_ID", 
       y="Settler Counts")
  
Recruits_by_SGD_level_V

## for Cabral 
Recruits_by_SGD_level_C <- totalcounts_tilelocation %>% 
  filter(Location=="Cabral") %>% 
  ggplot(aes(x=reorder(CowTagID, -total_count), 
             y=total_count, 
             fill=SGD_level)) + 
  geom_col() + 
  theme_blank() + 
  scale_fill_manual(values=c("darkseagreen4", "darkgoldenrod2", "coral4"), 
                    limits=c("Low", "Mid", "High")) + 
  labs(title="Cabral", 
       x="CowTag_ID", 
       y="Settler Counts")
  
Recruits_by_SGD_level_C


Recruits_by_SGD_level_C + Recruits_by_SGD_level_V
ggsave(here("Outputs", "RecruitmentTiles", "RecruitbySGDestimates.jpg"), 
       width = 14, height = 10)


### try with SE bars  ?? 
totalcounts_tilelocation2 <- totalcounts_tilelocation %>% 
  group_by(SGD_level, CowTagID, Location, total_count) %>% 
  summarize(mean_recruit = mean(total_count, na.rm=TRUE), 
            se_recruit = sd(total_count, na.rm=TRUE)/sqrt(n())) %>% 
  ungroup() 
 # geom_errorbar(aes(ymin=mean_settled-se_settled, ymax=mean_settled+se_settled), width=0.1) 


################################
### associated models 
#################################

## trying to run ANOVA to see if there is any significance between treatments and between sites  
Varari_recruitment <- totalcounts_tilelocation %>% 
   filter(Site=="Varari")

anova_recruits_Varari <- aov(total_count ~ SGD_level, data=Varari_recruitment)
summary(anova_recruits_Varari)
emmeans(anova_recruits_Varari, pairwise~"SGD_level", adjust="Tukey")

Cabral_recruitment <- totalcounts_tilelocation %>% 
   filter(Site=="Cabral")

anova_recruits_Cabral <- lm(total_count ~ SGD_level, data=Cabral_recruitment) 
summary(anova_recruits_Cabral)
emmeans(anova_recruits_Cabral, pairwise~"SGD_level", adjust="Tukey")

anova_recruits <- aov(total_count ~ SGD_level + Site, data=totalcounts_tilelocation)
summary(anova_recruits)
emmeans(anova_recruits, pairwise~"SGD_level", adjust="Tukey")
```


## want to look at tile data for each of the env parameters (April 17th, 2024)
## start with percent cover data 
### try with a regular barlplot and then stacked barplot because part out of whole 
```{r}

full_envdataRecruits3 <- full_envdataRecruits2 %>% 
  pivot_longer(cols = LiveCoral:Sand, names_to = "comm_type", values_to = "percent_cover") %>% 
  group_by(comm_type, CowTagID, Location) %>% 
  summarize(percent_total=sum(percent_cover)) 
  
full_envdataRecruits4 <- full_envdataRecruits3 %>% 
  pivot_wider(names_from = CowTagID, values_from = percent_total) 

full_envdataRecruits4 <- full_envdataRecruits4 %>% 
  select(!starts_with(c("Reef","RockWall","Sand"))) %>% ## gets rid of the extra data that I don't need - columns that start with Reef, Rockwall, or Sand 
  pivot_longer(cols = C1:VSEEP, names_to = "CowTagID", values_to = "percent_cover") %>% 
  drop_na(percent_cover)

#### now plot 
commcomp_plot_V <- full_envdataRecruits4 %>% 
  filter(Location=="Varari") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12", "V13", "V14", "V15", "V16", "V17", "V18", "V19", "V20", "VSEEP")),
             y=percent_cover,
             fill=comm_type)) + 
  geom_bar(position="stack", stat="identity") + 
  theme_blank() + 
  scale_fill_manual(values=c("darkolivegreen", "coral", "azure4", "burlywood3"),
                    limits=c("DeadCoral", "LiveCoral", "Rubble", "Sand")) + 
  labs(title="Varari", 
       x="CowTag_ID", 
       y="% cover of Comm Types") + 
  theme(axis.text.x = element_text(angle = 45))
  
  
commcomp_plot_V

## for Cabral 
commcomp_plot_C <- full_envdataRecruits4 %>% 
  filter(Location=="Cabral") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20", "CSEEP")),
             y=percent_cover,
             fill=comm_type)) + 
  geom_bar(position="stack", stat="identity") + 
  theme_blank() + 
  scale_fill_manual(values=c("darkolivegreen", "coral", "azure4", "burlywood3"),
                    limits=c("DeadCoral", "LiveCoral", "Rubble", "Sand")) + 
  labs(title="Cabral", 
       x="CowTag_ID", 
       y="% cover of Comm Types") + 
  theme(axis.text.x = element_text(angle = 45))
  
commcomp_plot_C




commcomp_plot_C + commcomp_plot_V


```


 
# was successful - now plot normally (April 18th, 2024)

```{r}
PercentCover_plot_V <- PercentCover3 %>% 
  filter(Location=="Varari") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12", "V13", "V14", "V15", "V16", "V17", "V18", "V19", "V20", "VSEEP")),
             y=percent_cover,
             fill=comm_type)) + 
  geom_bar(position="stack", stat="identity") + 
  theme_blank() + 
  scale_fill_manual(values=c("darkolivegreen", "coral", "azure4", "burlywood3"),
                    limits=c("DeadCoral", "LiveCoral", "Rubble", "Sand")) + 
  labs(title="Varari", 
       x="CowTag_ID", 
       y="% cover of Comm Types") + 
  theme(axis.text.x = element_text(angle = 45))

PercentCover_plot_V

## for Cabral 
PercentCover_plot_C <- PercentCover3 %>% 
  filter(Location=="Cabral") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20", "CSEEP")),
             y=percent_cover,
             fill=comm_type)) + 
  geom_bar(position="stack", stat="identity") + 
  theme_blank() + 
  scale_fill_manual(values=c("darkolivegreen", "coral", "azure4", "burlywood3"),
                    limits=c("DeadCoral", "LiveCoral", "Rubble", "Sand")) + 
  labs(title="Cabral", 
       x="CowTag_ID", 
       y="% cover of Comm Types") + 
  theme(axis.text.x = element_text(angle = 45))
  
PercentCover_plot_C


PercentCover_plot_C + PercentCover_plot_V
ggsave(here("Outputs", "RecruitmentTiles", "PercentCommunityCover.jpg"), 
       width = 14, height = 10)

```

## create a scatterplot to show comm comp data vs total number of recruits on tiles at each of these sites 

```{r}

CommComp_recruit_plot <- CommComp_recruit %>%
  ggplot(aes(x=recruit_total, 
             y=percent_cover, 
             fill=factor(comm_type))) +
  geom_point(size=4, shape=21, color="black") +
  scale_fill_manual(values=c("darkolivegreen", "coral", "azure4", "burlywood3"),
                    limits=c("DeadCoral", "LiveCoral", "Rubble", "Sand")) + 
  facet_wrap(~Location) + 
  theme_bw() + 
  labs(x="recruit counts", 
       y="percent cover of community types", 
       fill="community types")
  

CommComp_recruit_plot
ggsave(here("Outputs", "RecruitmentTiles", "RecruitCounts_by_PercentCover.jpg"), 
       width = 18, height = 10)

###############################
## also facet by each CowTag so can isolate specific correlations if there are any  
################################

CommComp_recruit_plot2V <- CommComp_recruit %>%
  filter(Location=="Varari") %>% 
  ggplot(aes(x=recruit_total, 
             y=percent_cover, 
             fill=factor(comm_type))) +
  geom_point(size=4, shape=21, color="black") +
  scale_fill_manual(values=c("darkolivegreen", "coral", "azure4", "burlywood3"),
                    limits=c("DeadCoral", "LiveCoral", "Rubble", "Sand")) + 
  facet_wrap(~CowTagID) + 
  theme_bw() + 
  labs(x="recruit counts", 
       y="percent cover of community types", 
       fill="community types")
  

CommComp_recruit_plot2V

###############################
CommComp_recruit_plot2C <- CommComp_recruit %>%
  filter(Location=="Cabral") %>% 
  ggplot(aes(x=recruit_total, 
             y=percent_cover, 
             fill=factor(comm_type))) +
  geom_point(size=4, shape=21, color="black") +
  scale_fill_manual(values=c("darkolivegreen", "coral", "azure4", "burlywood3"),
                    limits=c("DeadCoral", "LiveCoral", "Rubble", "Sand")) + 
  facet_wrap(~CowTagID) + 
  theme_bw() + 
  labs(x="recruit counts", 
       y="percent cover of community types", 
       fill="community types")
  

CommComp_recruit_plot2C

```


## create a plot to show just total recruit counts on the y axis by CowTag 
```{r}
## for Cabral 
recruit_plot_C <- RecruitmentCounts3 %>% 
  filter(Location=="Cabral") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20")), 
             y=recruit_total, 
             fill=CowTagID)) + 
  geom_bar(position="stack", stat="identity") + 
  theme_blank() + 
  labs(title="Cabral", 
       x="CowTag_ID", 
       y="Total Recruits per Plate") + 
  scale_fill_manual(values=rev(pnw_palette("Starfish", n=20)), 
                     guide="none") +
  theme(axis.text.x = element_text(angle = 45))

recruit_plot_C

## for Varari 
recruit_plot_V <- RecruitmentCounts3 %>% 
  filter(Location=="Varari") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12", "V13", "V14", "V15", "V16", "V17", "V18", "V19", "V20")), 
             y=recruit_total, 
             fill=CowTagID)) + 
  geom_bar(position="stack", stat="identity") + 
  theme_blank() + 
  labs(title="Varari", 
       x="CowTag_ID", 
       y="Total Recruits per Plate") + 
  scale_fill_manual(values=rev(pnw_palette("Starfish", n=20)), 
                     guide="none") +
  theme(axis.text.x = element_text(angle = 45))

recruit_plot_V

recruit_plot_V + recruit_plot_C 
ggsave(here("Outputs", "RecruitmentTiles", "RecruitCounts.jpg"), 
       width = 18, height = 10)


```


## create a new plot where recruit counts are colored by estimated SGD 
```{r}
recruit_plot_C2 <- RecruitmentCounts3 %>% 
  filter(Location=="Cabral") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20")), 
             y=recruit_total, 
             fill=SGD_level)) + 
  geom_bar(position="stack", stat="identity") + 
  theme_blank() + 
  scale_fill_manual(values=c("darkseagreen4", "darkgoldenrod2", "coral4"), 
                    limits=c("Low", "Mid", "High")) +
  labs(title="Cabral", 
       x="CowTag_ID", 
       y="Total Recruits per Plate") 
#  theme(axis.text.x = element_text(angle = 45))

recruit_plot_C2

## for Varari 
recruit_plot_V2 <- RecruitmentCounts3 %>% 
  filter(Location=="Varari") %>% 
  ggplot(aes(x=factor(CowTagID, level = c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12", "V13", "V14", "V15", "V16", "V17", "V18", "V19", "V20")), 
             y=recruit_total, 
             fill=SGD_level)) + 
  geom_bar(position="stack", stat="identity") + 
  theme_blank() + 
  labs(title="Varari", 
       x="CowTag_ID", 
       y="Total Recruits per Plate") + 
  scale_fill_manual(values=c("darkseagreen4", "darkgoldenrod2", "coral4"), 
                    limits=c("Low", "Mid", "High"))
 # theme(axis.text.x = element_text(angle = 45))

recruit_plot_V2

recruit_plot_V2 + recruit_plot_C2
ggsave(here("Outputs", "RecruitmentTiles", "RecruitCounts_bySGDest.jpg"), 
       width = 18, height = 10)

```



## now try to make a plot that incorporates env data with recruit counts (Arpil 18th, 2024 - UNFINISHED)
```{r}
## first join necessary dfs

AllChemData_edit <- AllChemData_August %>% 
  select(!c("Top_Plate_ID":"Plate_Seep", "M_C":"Lignin_Like")) 
  
AllChemData_edit_avg <- AllChemData_edit %>% 
  group_by(CowTagID) %>% 
  summarize(sal_avg = mean(Salinity), 
            temp_avg = mean(Temperature), 
            TA_avg = mean(TA), 
            pH_avg = mean(pH), 
            phos_avg = mean(Phosphate_umolL), 
            NN_avg = mean(NN_umolL), 
            silicate_avg= mean(Silicate_umolL), 
            ammonia_avg = mean(Ammonia_umolL))


CommComp_recruit_envdata <- CommComp_recruit %>% 
  left_join(AllChemData_edit_avg, join_by(CowTagID))

CommComp_recruit_envdata_long <- CommComp_recruit_envdata %>% 
  pivot_longer(cols="sal_avg":"ammonia_avg", names_to = "env_params")

######## now plot 
##### REMOVE SEEP DATA #####
CommComp_recruit_envdata_plot_C <- CommComp_recruit_envdata_long %>%
  filter(Location=="Cabral") %>% 
   drop_na(recruit_total) %>% 
  ggplot(aes(x=value, 
             y=log(recruit_total+1))) +
  geom_point(size=3, shape=21) + 
  facet_wrap(~env_params, scales = "free") + 
  theme_bw() + 
  labs(x="value", 
       y="recruit counts")

CommComp_recruit_envdata_plot_C

## for Varari 
CommComp_recruit_envdata_plot_V <- CommComp_recruit_envdata_long %>%
  #filter(Location=="Varari") %>% 
   drop_na(recruit_total) %>% 
  ggplot(aes(x=value, 
             y=log(recruit_total+1), 
             color=Location)) +
  geom_point(size=3, shape=21) + 
  facet_wrap(Location~env_params, scales = "free") + 
  theme_bw() + 
  labs(x="value", 
       y="recruit counts")

CommComp_recruit_envdata_plot_V




## run a model 
test_silicatemodelV <- anova(lm(data=CommComp_recruit_envdata_long %>%
  filter(env_params=="silicate_avg") %>% 
  filter(Location=="Varari") %>% 
    drop_na(recruit_total, value),
  log(recruit_total+1)~poly(value,2)))

check_model(test_silicatemodelV) 



### trying a bar plot 
CommComp_recruit_envdata_plot_C2 <- CommComp_recruit_envdata_long %>%
  filter(Location=="Cabral") %>% 
  group_by(env_params) %>% 
  ggplot(aes(x=env_params, 
             y=recruit_total, 
             fill=CowTagID)) +
  geom_bar(position="stack", stat="identity") +
 # scale_fill_viridis_b() + 
  theme_bw() + 
  labs(x="CowTag", 
       y="recruit counts")

CommComp_recruit_envdata_plot_C2



```













## try to make a PCA for the env data? 

```{r}

# Before we can use this data file, R wants ONLY trait data in order to do the PCA. 
# (just to get PCA scores).
AllChemData_edit_avg_PCA <- AllChemData_edit_avg %>% 
  select(!"CowTagID") %>% 
  drop_na()

# First, to get all of our traits on the same scale, we'll convert them to z-scores. You don't have to do this, but it is fairly common, and it can be helpful down the line:
envdata.scale <- scale(AllChemData_edit_avg_PCA, scale=TRUE, center=TRUE)

# Run the PCA with `princomp()`
PCAmodel <- princomp(envdata.scale, cor=FALSE)

# In princomp, the default is to use the covariance matrix. If you want to use the correlation matrix, then use cor=TRUE Here we converted to z-scores first, so all variables are on the same scale and we can use the covariancematrix. (The correlation matrix is the scaled covariance matrix, recall.)

summary(PCAmodel) 

# This shows amount of variance explained by each axis. It's actually a big wide
# table, with all 38 principle components. It tells us the amount of variance 
# explained by each axis, and the cumulative proportion of variance explained
# Axis 1 will always explain the most variation, Axis 2 the second most, etc.

# We can plot that data easily in a scree plot
plot(PCAmodel, type="lines")

# Or even prettier:
library(factoextra)
fviz_eig(PCAmodel)

PCAmodel$loadings  # Shows the loadings of each trait on each PC 
# --- make sure you scroll up, this is a long readout. 

PCAmodel$scores # Gives output of the principal components for each individual 
# on each PC --- another 

# If we want to use the PC scores for something else (maybe we want to use 
# PC1 to run an ANOVA?), then we can pull out that vector.

PC1 <- PCAmodel$scores[,1] # Pulls out the first column of the table 
PC1

# And we could run a quick ANOVA to see if guilds differ in PC1 scores. 
# (This works because the ordering of rows in the PC scores table is the same 
# as the order in the original data table.)
AllChemData_edit_avg <- AllChemData_edit_avg %>% 
  drop_na()

model1 <- lm(PC1~AllChemData_edit_avg$CowTagID)
anova(model1)


# Another common thing to do with PCA is to make a biplot
biplot(PCAmodel, xlab="PC1", ylab="PC2")
# The black numbers are each individual spider. The red lines are the vectors 
# for each trait.

# There are tons of options for playing around with the biplot. I'll just do 
# this to make this look a bit better so we can see differences among guilds

# I like using ggbiplot
library(devtools)
install_github("vqv/ggbiplot") #You only need to download this package once

# In this biplot code, I'm going to separate the spiders by guild (so I need to
# use my non-subsetted data file). So I use the original file to refer to 
# guilds, but the PCA data for everything else. I'm also going to put confidence 
# intervals around the individuals in each guild.

library(ggbiplot)

ggbiplot(PCAmodel, groups=AllChemData_edit_avg$CowTagID, ellipse=TRUE, circle=FALSE) +
  scale_color_discrete(name='') +
  geom_point(aes(colour=factor(AllChemData_edit_avg$CowTagID)), size = 1) +
  theme(legend.direction = 'horizontal', legend.position='bottom', legend.text=element_text(size=8))



```

















